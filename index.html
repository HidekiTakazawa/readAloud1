<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多言語学習用 音読アプリ (Final Hybrid)</title>
    <style>
        /* CSS: デザイン定義 */
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #2c3e50; }
        .screen { display: none; }
        .active { display: block; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        textarea { height: 100px; resize: vertical; }
        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 5px; margin-bottom: 5px; }
        .btn-primary { background-color: #3498db; color: white; }
        .btn-danger { background-color: #e74c3c; color: white; }
        .btn-success { background-color: #2ecc71; color: white; }
        .btn-secondary { background-color: #95a5a6; color: white; }
        #doc-list { list-style: none; padding: 0; }
        .doc-item { background: #ecf0f1; margin-bottom: 10px; padding: 15px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .doc-info { cursor: pointer; flex-grow: 1; }
        .doc-lang-badge { display: inline-block; background: #34495e; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 10px; }
        #player-display {
            font-size: 24px; line-height: 1.8; margin: 20px 0; padding: 20px; background: #fff; border: 2px solid #eee; border-radius: 8px; min-height: 150px; white-space: pre-wrap;
        }
        .highlight { background-color: #f1c40f; color: #000; border-radius: 3px; }
        .dimmed { opacity: 0.6; }
        .controls { text-align: center; margin-top: 20px; }
        #device-info { font-size: 0.8em; text-align: right; color: #888; margin-top: -10px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Multilingual Reader</h1>
    <div id="device-info"></div>

    <!-- 1. 一覧・編集画面 -->
    <div id="list-screen" class="screen active">
        <h2>文書一覧 / 登録</h2>
        <div style="background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <div class="form-group">
                <label>タイトル</label>
                <input type="text" id="input-title" placeholder="例: 自己紹介の練習">
            </div>
            <div class="form-group">
                <label>言語選択</label>
                <select id="input-lang">
                    <option value="en-US">英語 (English)</option>
                    <option value="zh-CN">中国語 (Chinese)</option>
                    <option value="ko-KR">韓国語 (Korean)</option>
                    <option value="ru-RU">ロシア語 (Russian)</option>
                </select>
            </div>
            <div class="form-group">
                <label>文章</label>
                <textarea id="input-text" placeholder="ここに読ませたい文章を入力してください"></textarea>
            </div>
            <input type="hidden" id="input-id">
            <div>
                <button class="btn-primary" onclick="saveDocument()">保存</button>
                <button class="btn-secondary" onclick="clearForm()">クリア</button>
            </div>
        </div>
        <ul id="doc-list"></ul>
    </div>

    <!-- 2. プレイヤー画面 -->
    <div id="player-screen" class="screen">
        <h2 id="player-title">タイトル</h2>
        <div id="player-display"></div>
        <div class="controls">
            <button class="btn-secondary" onclick="goBack()">戻る</button>
            <button id="btn-play" class="btn-success" onclick="togglePlay()">再生</button>
            <button id="btn-stop" class="btn-danger" onclick="stopSpeech()">停止</button>
        </div>
        <p style="text-align: center; font-size: 0.9em; color: #666;">※停止ボタンを押すまで無限ループします</p>
    </div>
</div>

<script>
    // --- 0. 環境判定 ---
    const isAndroid = /Android/i.test(navigator.userAgent);
    document.getElementById('device-info').innerText = isAndroid 
        ? "Mode: Android (文単位ハイライト)" 
        : "Mode: PC/iOS (単語単位ハイライト)";

    // --- 1. データ管理 ---
    const STORAGE_KEY = 'lang_learning_app_data_v3';

    function loadDocs() {
        const data = localStorage.getItem(STORAGE_KEY);
        return data ? JSON.parse(data) : [];
    }
    function saveDocs(docs) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(docs));
    }

    // --- 2. 画面操作 ---
    
    // 音声リストをキャッシュするための配列
    let availableVoices = [];

    window.onload = function() {
        renderList();
        
        // 音声リストの読み込み（iOS/Chrome対策）
        if(window.speechSynthesis) {
            // イベントで取得を試みる
            window.speechSynthesis.onvoiceschanged = function() {
                availableVoices = window.speechSynthesis.getVoices();
            };
            // 初回も強制実行
            availableVoices = window.speechSynthesis.getVoices();
        }
    };

    function renderList() {
        const docs = loadDocs();
        const listEl = document.getElementById('doc-list');
        listEl.innerHTML = '';
        const langMap = {'en-US':'英語', 'zh-CN':'中国語', 'ko-KR':'韓国語', 'ru-RU':'ロシア語'};

        docs.forEach(doc => {
            const li = document.createElement('li');
            li.className = 'doc-item';
            li.innerHTML = `
                <div class="doc-info" onclick="openPlayer('${doc.id}')">
                    <span class="doc-title">${escapeHtml(doc.title)}</span>
                    <span class="doc-lang-badge">${langMap[doc.lang] || doc.lang}</span>
                    <div style="font-size:0.8em; color:#666; margin-top:5px;">${escapeHtml(doc.text.substring(0, 30))}...</div>
                </div>
                <div>
                    <button class="btn-secondary" style="padding:5px 10px; font-size:12px;" onclick="editDocument('${doc.id}')">編集</button>
                    <button class="btn-danger" style="padding:5px 10px; font-size:12px;" onclick="deleteDocument('${doc.id}')">削除</button>
                </div>
            `;
            listEl.appendChild(li);
        });
    }

    function saveDocument() {
        const id = document.getElementById('input-id').value;
        const title = document.getElementById('input-title').value;
        const text = document.getElementById('input-text').value;
        const lang = document.getElementById('input-lang').value;

        if (!title || !text) { alert('タイトルと文章は必須です。'); return; }

        let docs = loadDocs();
        if (id) {
            const index = docs.findIndex(d => d.id === id);
            if (index !== -1) docs[index] = { id, title, text, lang };
        } else {
            docs.push({ id: Date.now().toString(), title, text, lang });
        }
        saveDocs(docs);
        clearForm();
        renderList();
    }

    function editDocument(id) {
        const docs = loadDocs();
        const doc = docs.find(d => d.id === id);
        if (doc) {
            document.getElementById('input-id').value = doc.id;
            document.getElementById('input-title').value = doc.title;
            document.getElementById('input-text').value = doc.text;
            document.getElementById('input-lang').value = doc.lang;
            window.scrollTo(0, 0);
        }
    }

    function deleteDocument(id) {
        if (!confirm('削除しますか？')) return;
        let docs = loadDocs();
        docs = docs.filter(d => d.id !== id);
        saveDocs(docs);
        renderList();
    }

    function clearForm() {
        document.getElementById('input-id').value = '';
        document.getElementById('input-title').value = '';
        document.getElementById('input-text').value = '';
    }

    function escapeHtml(str) {
        if(!str) return '';
        return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));
    }

    // --- 3. 再生機能 (Hybrid + Voice Selection) ---

    let currentDoc = null;
    let synth = window.speechSynthesis;
    let isPlaying = false;
    let isLooping = false;

    // Android用変数
    let sentenceQueue = [];
    let currentSentenceIndex = 0;

    function openPlayer(id) {
        const docs = loadDocs();
        currentDoc = docs.find(d => d.id === id);
        if (!currentDoc) return;

        document.getElementById('player-title').textContent = currentDoc.title;
        document.getElementById('player-display').innerText = currentDoc.text;

        document.getElementById('list-screen').classList.remove('active');
        document.getElementById('player-screen').classList.add('active');
    }

    function goBack() {
        stopSpeech();
        document.getElementById('player-screen').classList.remove('active');
        document.getElementById('list-screen').classList.add('active');
    }

    function togglePlay() {
        if (isPlaying) return;
        
        // 再生前に最新の音声リストを再取得（念のため）
        availableVoices = window.speechSynthesis.getVoices();
        
        startLoop();
    }

    function stopSpeech() {
        isPlaying = false;
        isLooping = false;
        synth.cancel();
        if(currentDoc) {
            document.getElementById('player-display').innerText = currentDoc.text;
        }
    }

    function startLoop() {
        if (!currentDoc) return;
        isPlaying = true;
        isLooping = true;

        if (isAndroid) {
            initAndroidMode();
        } else {
            speakWordMode();
        }
    }

    // ★重要: 言語コードから最適なVoiceオブジェクトを探す関数
    function getBestVoice(langCode) {
        if (!availableVoices.length) {
            availableVoices = window.speechSynthesis.getVoices();
        }
        // 1. 完全一致を探す (例: zh-CN === zh-CN)
        let found = availableVoices.find(v => v.lang === langCode);
        if (found) return found;

        // 2. 部分一致を探す (例: zh-CN で探して zh-Hans などがヒットする場合、または zh_CN)
        // 言語コードの頭2文字（en, zh, ru, ko）でマッチング
        const shortLang = langCode.substring(0, 2); 
        found = availableVoices.find(v => v.lang.startsWith(shortLang));
        if (found) return found;

        return null; // 見つからなければnull（ブラウザのデフォルトに任せる）
    }

    // ==========================================
    // モードA: PC/iOS (単語単位ハイライト)
    // ==========================================
    function speakWordMode() {
        synth.cancel();
        if(!isLooping) return;

        const utterance = new SpeechSynthesisUtterance(currentDoc.text);
        utterance.lang = currentDoc.lang;
        utterance.rate = 1.0;

        // ★iOS修正箇所: 音声を明示的にセットする
        const targetVoice = getBestVoice(currentDoc.lang);
        if (targetVoice) {
            utterance.voice = targetVoice;
            console.log("Voice set to:", targetVoice.name);
        }

        utterance.onboundary = function(event) {
            const text = currentDoc.text;
            const index = event.charIndex;
            let length = event.charLength;

            if (!length && length !== 0) {
                const nextSpace = text.indexOf(' ', index);
                if (nextSpace === -1) {
                    length = text.length - index;
                } else {
                    length = nextSpace - index;
                }
            }

            const before = text.substring(0, index);
            const target = text.substring(index, index + length);
            const after = text.substring(index + length);

            document.getElementById('player-display').innerHTML = 
                escapeHtml(before) + 
                '<span class="highlight">' + escapeHtml(target) + '</span>' + 
                escapeHtml(after);
        };

        utterance.onend = function() {
            if (isLooping) {
                setTimeout(() => { if(isLooping) speakWordMode(); }, 500);
            } else {
                isPlaying = false;
            }
        };

        utterance.onerror = function(e) {
            console.error('Playback Error', e);
            isPlaying = false;
        };

        synth.speak(utterance);
    }

    // ==========================================
    // モードB: Android (文単位ハイライト)
    // ==========================================
    function initAndroidMode() {
        const text = currentDoc.text;
        const regex = /[^.?!。？！\n]+[.?!。？！\n]*/g; 
        sentenceQueue = text.match(regex) || [text];
        
        currentSentenceIndex = 0;
        speakNextSentenceAndroid();
    }

    function speakNextSentenceAndroid() {
        if (!isLooping) return;

        if (currentSentenceIndex >= sentenceQueue.length) {
            currentSentenceIndex = 0;
            setTimeout(speakNextSentenceAndroid, 500);
            return;
        }

        const sentence = sentenceQueue[currentSentenceIndex];
        const utterance = new SpeechSynthesisUtterance(sentence);
        utterance.lang = currentDoc.lang;
        
        // Androidでも念のため音声を指定しておく
        const targetVoice = getBestVoice(currentDoc.lang);
        if (targetVoice) utterance.voice = targetVoice;

        updateHighlightAndroid();

        utterance.onend = function() {
            if (isLooping) {
                currentSentenceIndex++;
                speakNextSentenceAndroid();
            }
        };
        utterance.onerror = function(e) {
            console.error(e);
            isPlaying = false;
        };

        synth.speak(utterance);
    }

    function updateHighlightAndroid() {
        const display = document.getElementById('player-display');
        let html = '';
        sentenceQueue.forEach((sent, idx) => {
            const escapedSent = escapeHtml(sent);
            if (idx === currentSentenceIndex) {
                html += `<span class="highlight">${escapedSent}</span>`;
            } else {
                html += `<span class="dimmed">${escapedSent}</span>`;
            }
        });
        display.innerHTML = html;
    }

</script>

</body>
</html>